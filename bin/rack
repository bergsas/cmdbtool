#!/usr/bin/python
# -*- coding: utf-8 -*-
import sys
import os
import json


# Comments are for sissies.
# This is not done yet.

sys.path.append("%s/.." %(os.path.dirname(os.path.abspath(__file__)))) # Ho ho ho!

from argparse import ArgumentParser
from libcmdb2.core import CMDBServer

from cmdbtool import *

#parser.add_argument("-r", "--resource", type=str, metavar="resource", help="Lookup specified resource.")


parser = ArgumentParser(description='Rack tool')
#parser.add_argument("--rack", type=str, metavar="rack")
#parser.add_argument("--units", "-u", type=str)
parser.add_argument("-D", "--dump", action='append')
parser.add_argument("-n", "--no-reverse", dest='reverse', action='store_false', default=True,  help="Don't resolve rack items's hostnames.")
parser.add_argument("-i", "--informative", action="store_true", default=False, help="Print info about each rack, in addition to rack overview")

#parser.add_argument("-r", "--resource", type=str, metavar="resource", help="Lookup specified resource.")
#parser.add_argument("-F", "--follow", help="Follow resources recursively", action="store_true")

args, leftover = parser.parse_known_args()
try:

  client = CMDB.Client('http://cmdb.met.no', '/api/v2/')
  
  rackunit_resource_name = 'rackunit'
  rack_resource_name = 'rack'
  host_resource_name = 'host'
  item_resource_name = 'item'

except KeyboardInterrupt:
  print '^C'
  exit(1)


# Program: begin!
def __main__():
  try:
    racks = {}
    for rack in leftover:
      racks[rack] = get_rack(client, rack)
  
    # Reverse lookup stuff.
    items = {}
    widths = {}
    racksize = 0

    for rack in leftover:
      if not racks[rack]:
        continue

      if not racks[rack]['info'] or not racks[rack]['info']['itemmodel']:
        if 42 > racksize:
          racksize = 42

      if 'itemmodel' in racks[rack]['info'] and 'size' in racks[rack]['info']['itemmodel']:
        thissize = racks[rack]['info']['itemmodel']['size']
        if thissize > racksize:
          racksize = thissize

      widths[rack] = 0
      
      for rackpos,rackunit in racks[rack]['units'].items():
        item_id = rackunit['item']['id']
        if args.reverse and not item_id in items:
          items[item_id] = reverse_item(client, item_id)
        
        if items[item_id]:
          racks[rack]['units'][rackpos]['display'] = items[item_id]
          width = len(items[item_id]) 
          if widths[rack] < width:
            widths[rack] = width
        
        else:
          racks[rack]['units'][rackpos]['display'] = rackunit['item']['itemmodel']['name']
       
    # Calculate width
    total = 0
    formater = []
    for size in widths.values():
      formater += ["%%-%d.%ds" %(size +3,size +3)]
      total += size + 3

    formater = '|'.join(formater)

    print ("   |"+formater)%tuple(leftover)
    formater = "%2d |" + formater
    print ""    
    for row in range(racksize, 0, -1):
      rowunits = []
      for rack in leftover:
        ru = racks[rack]['units'].get(row, None)
        if not ru:
          rowunits += ['']
          continue
        rowunits += [ru['display']]
      print formater%tuple([row] + rowunits)

  except KeyboardInterrupt:
    print "^c"


    # Paint rack canvas. :)
    # Sizes

def get_rack(client, rack):
  rack_search = client.init_basic_search(rack_resource_name, ['name===%s'%(rack)]) 
  rack_query = client.new_query(rack_resource_name, **rack_search)
  rack_objects = True

  while rack_objects:
    rack_objects = rack_query.object_query()
       
    if not rack_objects:
      break

    for rack_obj in rack_objects:
      if args.dump and 'rack' in args.dump:
        print "*** dump rack:"
        print json.dumps(rack_obj, indent=2)
        print "***"
          
      rackinfo = client.get_dict(rack_obj['item'], -1)
      
      if not rackinfo:
        continue

      if args.dump and 'rackinfo' in args.dump:
        print json.dumps(rackinfo, indent=2)

      rackunit_search = client.init_basic_search(rackunit_resource_name, ['rack.id===%s'%(rack_obj['id'])])
      return {
        'info': rackinfo,
        'units': get_rackunits(client,client.new_query(rackunit_resource_name, **rackunit_search))
      }

def get_rackunits(client, query):
  objects = True
  rack = {}
  while objects:
    objects = query.object_query()

    if not objects:
      break

    # These should probably be references in a better
    #   manner. Oh well. 
    for obj in objects:
      obj['item'] = client.get_dict(obj['item'], -1)
      if not obj['item']:
        obj['item'] = {}
      obj['rack'] = client.get_dict(obj['rack'], -1)
      if not obj['rack']:
        obj['rack'] = {}
      obj['width'] = 0  # HACKYKYK
      if args.dump and 'item_json' in args.dump:
        print json.dumps(obj['item'], indent=2)

      rack[obj['ruid']] = obj
  return rack
  

def reverse_item(client, item):
 host_search = client.init_basic_search(host_resource_name, ['item.id===%s'%(item)])
 host_query = client.new_query(host_resource_name, **host_search)
 host_objects = host_query.object_query()
 for host_object in host_objects:
   if 'name' in host_object:
     return host_object['name']
 return None
__main__()
# vim: syntax=python
